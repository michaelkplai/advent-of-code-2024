const UP = { x: 0, y: -1 };
const RIGHT = { x: 1, y: 0 };
const DOWN = { x: 0, y: 1 };
const LEFT = { x: -1, y: 0 };

function solve1(input: string): number {
  const been = new Map<string, true>();

  const g = input.split("\n").map((line) => line.split(""));
  const yLength = g.length;
  const xLength = g[0].length;

  function findInitial() {
    for (let x = 0; x < xLength; x++) {
      for (let y = 0; y < yLength; y++) {
        const tile = g[y][x];
        if (tile === "^") {
          return { x, y, dir: UP };
        } else if (tile === ">") {
          return { x, y, dir: RIGHT };
        } else if (tile === "v") {
          return { x, y, dir: DOWN };
        } else if (tile === "<") {
          return { x, y, dir: LEFT };
        }
      }
    }
  }

  let { x, y, dir } = findInitial()!;
  been.set(`${x},${y}`, true);

  function nextDir(dir: { x: number; y: number }) {
    // up
    if (dir.x === 0 && dir.y === -1) {
      return RIGHT; // right
    } else if (dir.x === 1 && dir.y === 0) {
      return DOWN; // down
    } else if (dir.x === 0 && dir.y === 1) {
      return LEFT; //left
    } else if (dir.x === -1 && dir.y === 0) {
      return { x: 0, y: -1 };
    } else return dir;
  }

  // x, y are in a valid location, when it's not exit
  while (true) {
    const next = { x: x + dir.x, y: y + dir.y };
    if (next.x < 0 || next.x >= xLength || next.y < 0 || next.y >= yLength) {
      return been.size;
    }

    if (g[next.y][next.x] === "#") {
      dir = nextDir(dir);
    } else {
      x = next.x;
      y = next.y;
      been.set(`${x},${y}`, true);
    }
  }
}

const EXAMPLE_INPUT = `....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...`;

const PUZZLE_INPUT = `....................................#............##........#..#.#..#.........#.............#..............#.......................
..................##.........#....................##.....#.......#.......................................#..........#.............
.......#...........#.........................................................................................#.#.#................
.#..........#...............................#....................................#...#.....#...#.#....................#....#......
..........#..........................................#............#.........................#..#......#....#..#..........#........
..........................................................................#..........................................#.........#..
.....#....#...........................#......#..........#........................#..........#.............#...........#..........#
................#.......................#...........#.............................#.....#..#..................................#...
........................................................................#..#.......................................#..............
........#......................#.....#.......#.............#....#.........#....#........................#.............#...........
.............#....#.......#........#..#.......##................#.......................................#.........................
......#..............#.#...#...............#.........................#.....#............#..#.........#...............#............
..................#...#..............................................#................#.......#................#..................
....#...#.............#........................#....................................#......#................#......#..............
..........................................................................................#...#.........##........................
.............#.#...............#.....#.#......#.............................#.......................................#.....#.......
.................................................#................................................................#...............
........#.#......................#......#........#.......................................................#........................
....#........#......#..................................................................................#............#.............
...........#.........#.......#...............#........................#........................................................#.#
........................##..................#........................#..........................................#.............#...
..........#........#........#.........#..................#.....#..............................#..#..............#.................
#..............................................................#..#............................#..........#.......................
.................................................................#...............#...#.#.........#.#.................#...........#
.....................................#.....................#.....................#........#....#....#.............................
#..#................#.....#....................................##............#...............#...#..........#.....................
.................#.....#.....................#................#...........#...................................................#...
..................................#........#.................#....#..................#.......................................#....
..#....#............................#................................................##.........................................#.
...............#......................................................#......##...................................................
.........................#..................................#................##.#..#.#.................#.......#..................
.................#......................................#...#.....................................................................
.........#..........................................................................................#.......#.....................
....##..#.........#..............#..#............#............#...................................#...............................
......#.......................................#................................................................#..................
....#..................#............................#................................................................#............
...............................##.#..............#....#............#.........................................#.....#..............
........#........#....#.................................................................#.....#...................#...............
#...........#..#.........................................#..................................................#..##.......#.....#..#
................#......#...........##..........................................................#....#.............................
..........#..........#.............................................................#..............#.................#..........#..
#.................#....................................................................................#..#..............#........
.....#..............#.........................#.....#...........#......................#..........................................
.....##.....................#...............................................................#.....................................
...................#.................................................................................#.....................#..#...
...............................................^......................#...........................#...............................
.......#...............#.........#.........#......#.......................................................................#.......
........#.........#..#..##.................................#.....#..............#...........#..#........#.........................
..............................................................................#......#.#...............#..#..#.....#....#.........
............#...#.......##............#....#...........................................................................#..........
..................................##........#.....##.......#......................................................................
.......................#...........................................#..................................#...#.........#.............
............#......................................................#....#..........#...................#........................#.
....................................................#......................#..........................#....#......................
..................#.##....................................#..................................#.................#....#...#.........
........#.....................................................................................#...#...............................
....................................................#..........................................#........#..#.#.................#..
....#...........#..#......#.........................#.....................#............................#.....#.#..............#...
.............................#.......#..........#..................................................................#....#.....#...
.....#.#................#...................#...............................................#.....................................
....#........................................#......#.............................#...............................................
.......#..........#........................#.....................................#..............#......#...##.....................
.....#..#.............................##........................................................#.....#..............#.#..........
...........................................#......#......................................#..............#.........................
...................#.........#....#................#.....#.........#....................#............#..#........#...............#
.....#.....................#......................................................................#...............................
...............#.......................................#...#.................#..............#.....................................
.........................#........................................................#...............................................
..................................#..........................................#...........#.....................#..................
.......................#.#............#.........................................#.................................................
..........................#...................#......................#......................................#.....................
.........#.........................#..............................................................#...............................
..#..............................#...............#..................................###..........................................#
.............................................#...............#.....#........................................................#..#..
................#..........................#.......................................#........................................##.#..
......##........#.....................................#............#..................#...............................#...........
..#..................#......................................#....#.......................#................................#.......
........................#...............#....#...#..........................................................................#.....
.............#.#..........#...#....#.................##...........................................................................
......#....#.......................................................................#.....................................#..#.....
.............#.......#............#...#..........#...............#..................................................#..........#..
..........................#...........................................................#.............#.............................
#......................................#........#......#..........................................................................
................#..........................................................#......................................................
..................#................................................................#..........................#..........#.......#
.......#.....#............##..............................................................#....................#.....#......#.....
...........................................#..........#.#............................................#............................
.......#.......................#..........................................................#.......................................
.................#........................#.........#...#............................................................#............
................................................#...................#.........#...........#...........................#...........
..#..............#......#..............................##............#..................#.......#.................................
.#.#.........................................#......##.....##........#.............#..#..................##....#.#...#............
..#.....................#.......#....#...............#...............#...................................................#........
.#...#...............#..................................................................#..........#....#.................#.#.....
.#...................#...................................................................#.............#.......................#..
.....................................#.....#..#...........#...........#..........#....................................#...........
.................................................................................#..#.............##....#...#............#........
......................#....#........#......#...................#.............................................#....................
.......................................#..........................#............................#.#..........................#.....
.#........................##....................................#.......#...........................#..#.......................#..
.........#.........#................................................................#.................#........#..................
..............#.......#.....#....................#........##.............#....#...............#.............#...........#...#.....
.................................................................#..#........#...#...#.........#..................................
................#......##..........#..........#.........#....#............................................#.#.............#.......
...#...................................................................#.......................................#..................
.......#..................#............#.....#................#..#....##.......#...............#..................................
............#............##....#...................#..........................#......................................#...#...#....
......#.....#..........##...............#......#...............................#......#...........................................
.................#.......#.......................................................#............#........#...#.......#...........#..
......................##........#...................#.....#....................#...#....#........................#................
.................#.....#.......#...........#.......#....................##....................................................#.#.
......#....................................#.........................#..................................#................#.#..#...
..............#...........................................................................................................#.......
#.#......#.................................................................................#...........#...#......................
...........................................#.#........#....#............#.....................#...................................
...#.............#.....................................................................................................#..........
..............#..........#............#...#..............#........................................##........#.....#.......#.......
..................##........#.............................................#.........................................###...........
..........#......................#............................................................................#....#..............
.............#........#.............#.#...............#.....#..........#.....#....#...#...........#....#..........................
........#...#.......#........................#.............#..........#........#.......................#..........................
..................................................................#...............#......#...#.......#............................
.............#..........#...................##.............#.........#..................#.........................................
.#.....#..#...#...............#.#.............#...........#.......................................................................
..............#..#.........................#..............#..#..............#.......................#.#...........................
............#.......................#....#................#..........#.......................#.....................#..............
#.................#............................#...##....#.....#.....................................................#............
.............................#........................#..................................................#....#...................
.##...........................................#.....#....#....#.......................#...#.....#...#............#................
........#.............#.........#..............#........................#.....................#...#...............................`;

console.log(solve1(EXAMPLE_INPUT));
console.log(solve1(PUZZLE_INPUT));

// solve2
// If you reach a location that's already been reached AND store the direction of the previous obstruction

function solve2(input: string): number {
  const been = new Map<string, { x: number; y: number }>();

  const g = input.split("\n").map((line) => line.split(""));
  const yLength = g.length;
  const xLength = g[0].length;

  function findInitial() {
    for (let x = 0; x < xLength; x++) {
      for (let y = 0; y < yLength; y++) {
        const tile = g[y][x];
        if (tile === "^") {
          return { x, y, dir: UP };
        } else if (tile === ">") {
          return { x, y, dir: RIGHT };
        } else if (tile === "v") {
          return { x, y, dir: DOWN };
        } else if (tile === "<") {
          return { x, y, dir: LEFT };
        }
      }
    }
  }

  let { x, y, dir } = findInitial()!;
  been.set(`${x},${y}`, dir);

  // x, y are in a valid location, when it's not exit
  while (true) {
    const next = { x: x + dir.x, y: y + dir.y };
    if (next.x < 0 || next.x >= xLength || next.y < 0 || next.y >= yLength) {
      break;
    }

    if (g[next.y][next.x] === "#") {
      dir = nextDir(dir);
    } else {
      x = next.x;
      y = next.y;
      been.set(`${x},${y}`, dir);
    }
  }

  // add an obstacle in each of the possible locations and see if they loop forever

  let obstacles = 0;

  const initial = findInitial()!;

  for (const coordinateString of been.keys()) {
    const [x, y] = coordinateString.split(",").map(Number);
    if (x === initial.x && y === initial.y) continue;
    const copyG = [...g.map((l) => [...l])];
    copyG[y][x] = "#";
    if (test(copyG)) obstacles++;
  }

  return obstacles;
}

function nextDir(dir: { x: number; y: number }) {
  // up
  if (dir.x === 0 && dir.y === -1) {
    return RIGHT; // right
  } else if (dir.x === 1 && dir.y === 0) {
    return DOWN; // down
  } else if (dir.x === 0 && dir.y === 1) {
    return LEFT; //left
  } else if (dir.x === -1 && dir.y === 0) {
    return { x: 0, y: -1 };
  } else return dir;
}

function test(g: string[][]) {
  const been = new Map<string, { x: number; y: number }>();

  const yLength = g.length;
  const xLength = g[0].length;

  function findInitial() {
    for (let x = 0; x < xLength; x++) {
      for (let y = 0; y < yLength; y++) {
        const tile = g[y][x];
        if (tile === "^") {
          return { x, y, dir: UP };
        } else if (tile === ">") {
          return { x, y, dir: RIGHT };
        } else if (tile === "v") {
          return { x, y, dir: DOWN };
        } else if (tile === "<") {
          return { x, y, dir: LEFT };
        }
      }
    }
  }

  let { x, y, dir } = findInitial()!;
  been.set(`${x},${y}`, dir);

  while (true) {
    const next = { x: x + dir.x, y: y + dir.y };
    if (next.x < 0 || next.x >= xLength || next.y < 0 || next.y >= yLength) {
      return false;
    }

    if (g[next.y][next.x] === "#") {
      dir = nextDir(dir);
    } else {
      x = next.x;
      y = next.y;
      if (been.get(`${x},${y}`) === dir) return true;
      been.set(`${x},${y}`, dir);
    }
  }
}

console.log(solve2(EXAMPLE_INPUT));
console.time("part2");
console.log(solve2(PUZZLE_INPUT));
console.timeEnd("part2");
